<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <title>HitechAutoworks</title>
    <meta content="" name="description">
    <meta content="" name="keywords">

    <!-- Favicons -->
    <link href="/assets/img/favicon.png" rel="icon">
    <link href="/assets/img/apple-touch-icon.png" rel="apple-touch-icon">

    <!-- Google Fonts -->
    <link href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
          rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.2/css/boxicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.bubble.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/simple-datatables@14.0.1/simple-datatables.min.css" rel="stylesheet">

    <!-- Template Main CSS File -->
    <link href="/assets/css/style.css" rel="stylesheet">
<style>
    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 50px;
        border: 1px solid #888;
        width: 80%;
    }


</style>
</head>
<body>
<div th:replace="~{common/header.html}"></div>
<div th:replace="~{common/sidebar.html}"></div>

<!-- 입력 내용 -->
<main id="main" class="main">

    <div class="pagetitle">
        <h1>작업 조회</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="user/mainpage">Home</a></li>
                <li class="breadcrumb-item active"><a href="user/common"></a>작업 조회</li>
            </ol>
        </nav>
    </div><!-- End Page Title -->

    <form id="actionForm" method="post">
        <div class="input-group mb-3">
            <input type="text" class="form-control" placeholder="사원이름 입력" aria-label="Recipient's username"
                   aria-describedby="button-addon2" name="worker"> &nbsp; &nbsp; &nbsp; &nbsp;
            <input type="text" class="form-control" placeholder="사원번호 입력" aria-label="Recipient's username"
                   aria-describedby="button-addon2" name="workerCode"> &nbsp; &nbsp;
            <button class="btn btn-outline-secondary" type="button" id="button-addon2" onclick="search()">검색</button>
            <button class="btn btn-outline-secondary" type="button" id="button-addon3" onclick="openModal()" >작업등록</button>

        </div>
    </form>
        <!-- 모달 구조 -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <h2 style="text-align: center">작업 등록</h2>

                    <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-end">예약번호</label>
                        <div class="col-sm-8">
                            <select name="resCode" id="resCode" style="width: 100%;" class="form-control" ></select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-end">작업자</label>
                        <div class="col-sm-8">
                            <!-- 작업자 선택 박스 -->
                            <select id="workerCode" style="width: 100%;" class="form-control" multiple></select>
                            <!-- 추가 및 삭제 버튼 -->
                            <input type="button" name="button" value="추가" onclick="addWorker()">
                            <input type="button" name="removeButton" value="삭제" onclick="removeWorker()"><br><br>
                            <!-- 선택된 작업자들을 보여주는 선택 박스 -->
                            <select name="userName" id="selectedWorkers" style="width:420px;" size="7" multiple>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-end">작업 내용</label>
                        <div class="col-sm-8">
                            <input name="content" id="content" type="text" class="form-control" >
                        </div>
                    </div>
                    <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-end" multiple>필요 부품</label>
                        <div class="col-sm-8">
                            <select id="partName" style="width: 100%;" class="form-control" multiple></select>
                            <!-- 추가 및 삭제 버튼 -->
                            <input type="button" name="button" value="추가" onclick="addPart()">
                            <input type="button" name="removeButton" value="삭제" onclick="removePart()"><br><br>
                            <!-- 선택된 작업자들을 보여주는 선택 박스 -->
                            <select name="partName" id="selectedParts" style="width:420px;" size="7" multiple>

                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-end">진행상황</label>
                        <div class="col-sm-8">
                            <select name="status" style="width: 100%;" id="status" class="form-control">
                                <option>대기</option>
                                <option>진행중</option>
                                <option>완료</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-end">날짜</label>
                        <div class="col-sm-8">
                            <input name="date" id="datetime" type="datetime-local" class="form-control" >
                        </div>
                    </div>
                    <div class="row mb-3">
                        <label class="col-sm-4 col-form-label text-end">예상시간</label>
                        <div class="col-sm-8">
                            <input name="extraTime" id="extraTime" type="number" class="form-control">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col text-end">
                            <button type="submit" class="btn btn-modify " onclick="repairRegist()" >등록</button>
                            <button type="button" class="btn btn-modify"  onclick="closeModal()">취소</button>
                        </div>
                    </div>

            </div>
        </div>

        <script>
            document.getElementById("resCode").addEventListener("click" , () =>{
                let codeValue = document.getElementById("resCode").value; // 입력 필드 값 가져오기
                fetch("/repair/getDate", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                       code:codeValue
                    })
                }) .then(response => response.json())
                    .then(result => {
                        document.getElementById("datetime").value = result.res_date;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            });
            function getAllSelectedWorkerValues() {
                let selectBox = document.querySelector('#selectedWorkers');
                let values = Array.from(selectBox.options).map(option => option.value);

                return values;
            }

            function getAllSelectedPartValues() {
                let selectBox = document.querySelector('#selectedParts');
                let values = Array.from(selectBox.options).map(option => option.value);

                return values;
            }
            function repairRegist(){

                var resCode =  document.getElementById("resCode").value;
                var worker = getAllSelectedWorkerValues();
                var part = getAllSelectedPartValues();
                var date = document.getElementById("datetime").value;
                var status = document.getElementById("status").value;
                var extraTime = document.getElementById("extraTime").value;
                var content = document.getElementById("content").value;


                fetch("/user/repair/regist", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        resCode:resCode,
                        worker:worker,
                        part:part,
                        content:content,
                        date :date,
                        status:status,
                        extraTime:extraTime
                    })
                }) .then(response => response.json())
                    .then(result => {
                        if(result == "1"){
                            alert("등록되었습니다.")
                            location.href="/user/repair"
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }

            document.getElementById('datetime').addEventListener('input', function() {
                var dateTimeInput = this.value;
                if (dateTimeInput) {
                    var [date, time] = dateTimeInput.split('T');
                    var [hours, minutes] = time.split(':');
                    if (minutes !== "00") {
                        // 분을 00으로 설정
                        var newTime = hours + ':00';
                        this.value = date + 'T' + newTime;
                    }
                }
            });

            function search() {
                document.getElementById("actionForm").action = "/user/repair/repairSearch";
                document.getElementById("actionForm").submit();
            }

            // 모달 열기 함수
            function openModal() {
                document.getElementById("myModal").style.display = "block";
            }

            // 모달 닫기 함수
            function closeModal() {
                document.getElementById("myModal").style.display = "none";
            }

            // 모달 외부 클릭시 닫기
            window.onclick = function(event) {
                if (event.target == document.getElementById("myModal")) {
                    closeModal();
                }
            }
            function addPart(){
                var partSelect = document.getElementById('partName');
                var selectedPartSelect = document.getElementById('selectedParts');

                for (var i = 0; i < partSelect.options.length; i++) {
                    if (partSelect.options[i].selected) {
                        var option = document.createElement("option");
                        option.text = partSelect.options[i].text;
                        option.value = partSelect.options[i].value;
                        option.selected = partSelect.options[i].selected;
                        selectedPartSelect.appendChild(option);
                        // Optionally, remove the added option from the workerCode select box
                        partSelect.remove(i);
                        i--; // Adjust index due to removal
                    }
                }
            }
            function removePart() {
                var partSelect = document.getElementById('partName');
                var selectedPartSelect = document.getElementById('selectedParts');

                // Loop through the selected options in selectedWorkers and add them back to workerCode
                for (var i = 0; i < selectedPartSelect.options.length; i++) {
                    if (selectedPartSelect.options[i].selected) {
                        var option = document.createElement("option");
                        option.text = selectedPartSelect.options[i].text;
                        option.value = selectedPartSelect.options[i].value;

                        partSelect.appendChild(option);
                        // Remove the added option from the selectedWorkers select box
                        selectedPartSelect.remove(i);
                        i--; // Adjust index due to removal
                    }
                }
            }
            function addWorker() {
                var workerCodeSelect = document.getElementById('workerCode');
                var selectedWorkersSelect = document.getElementById('selectedWorkers');

                for (var i = 0; i < workerCodeSelect.options.length; i++) {
                    if (workerCodeSelect.options[i].selected) {
                        var option = document.createElement("option");
                        option.text = workerCodeSelect.options[i].text;
                        option.value = workerCodeSelect.options[i].value;
                        option.selected = workerCodeSelect.options[i].selected;
                        selectedWorkersSelect.appendChild(option);
                        // Optionally, remove the added option from the workerCode select box
                        workerCodeSelect.remove(i);
                        i--; // Adjust index due to removal
                    }
                }
            }
            function removeWorker() {
                var workerCodeSelect = document.getElementById('workerCode');
                var selectedWorkersSelect = document.getElementById('selectedWorkers');

                // Loop through the selected options in selectedWorkers and add them back to workerCode
                for (var i = 0; i < selectedWorkersSelect.options.length; i++) {
                    if (selectedWorkersSelect.options[i].selected) {
                        var option = document.createElement("option");
                        option.text = selectedWorkersSelect.options[i].text;
                        option.value = selectedWorkersSelect.options[i].value;
                        workerCodeSelect.appendChild(option);
                        // Remove the added option from the selectedWorkers select box
                        selectedWorkersSelect.remove(i);
                        i--; // Adjust index due to removal
                    }
                }
            }
            fetch("/employee/repair/part")
                .then(res => res.json())
                .then(data =>{
                    const $partName = document.getElementById('partName');

                    for(let index in data){
                        const $option = document.createElement("option");
                        $option.value = data[index].partName;
                        $option.textContent = data[index].partName;
                        $partName.appendChild($option);
                    }
                })
            fetch("/employee/repair/worker")
                .then(res => res.json())
                .then(data =>{
                    const $workerCode = document.getElementById('workerCode');

                    for(let index in data){
                        const $option = document.createElement("option");
                        $option.value = data[index].userName;
                        $option.textContent = data[index].userName;
                        $workerCode.appendChild($option);
                    }
                })
            fetch("/employee/repair/res")
                .then(res => res.json())
                .then(data =>{
                    const $resCode = document.getElementById('resCode');

                    for(let index in data){
                        const $option = document.createElement("option");
                        $option.value = data[index].code;
                        $option.textContent = data[index].code;
                        $resCode.appendChild($option);
                    }
                })


        </script>

    <table class="table table-bordered">
        <thead class="table-light">
        <tr>
            <th scope="col">예약 번호</th>
            <th scope="col">작업내용</th>
            <th scope="col">작업 상태</th>
            <th scope="col">작업 날짜</th>
            <th scope="col">작업자</th>
            <th scope="col">필요 부품</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="repair : ${repairList}">
            <td th:text="${repair['res_code']}"></td>
            <td th:text="${repair['repair_content']}"></td>
            <td th:text="${repair['repair_status']}"></td>
            <td th:text="${repair['repair_date']}"></td>
            <td th:text="${repair['repair_workers']}"></td>
            <td th:text="${repair['part_names']}"></td>
            <td>
                <button id="viewBtn" class="btn btn-light" th:onclick="'repairDetail(' + ${repair['res_code']} + ')'">상세보기</button>
            </td>
        </tr>
        </tbody>
    </table>
</main>
<script>

    function repairDetail(resCode) {
        location.href = '/user/repairdetail?resCode=' + resCode;
    }
</script>

<div th:replace="~{common/footer.html}"></div>
</body>
</html>