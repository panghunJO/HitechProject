<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ohgiraffers.hitechautoworks.repair.dao.RepairMapper">

    <resultMap id="res" type="com.ohgiraffers.hitechautoworks.res.dto.ResDTO">
        <id property="code" column="res_code"/>
        <result property="title" column="res_title"/>
        <result property="option" column="res_option"/>
        <result property="date" column="res_date"/>
        <result property="extra" column="res_extra"/>
        <association property="userDTO" javaType="com.ohgiraffers.hitechautoworks.auth.dto.UserDTO">
            <id property="userCode" column="user_code"/>
            <result property="userId" column="user_id"/>
            <result property="password" column="password"/>
            <result property="userName" column="user_name"/>
            <result property="userRole" column="user_role"/>
        </association>
    </resultMap>

    <resultMap id="user" type="com.ohgiraffers.hitechautoworks.auth.dto.UserDTO">
        <id property="userCode" column="user_code"/>
        <result property="userId" column="user_id"/>
        <result property="password" column="password"/>
        <result property="userName" column="user_name"/>
        <result property="userRole" column="user_role"/>
    </resultMap>
    <resultMap id="worker" type="com.ohgiraffers.hitechautoworks.repair.dto.WorkerDTO">

        <association property="resDTO" resultMap="res" />
        <association property="userDTO" resultMap="user" />
    </resultMap>
    <resultMap id="part" type="com.ohgiraffers.hitechautoworks.part.dto.PartDTO">
        <id property="partCode" column="part_code"/>
        <result property="partName" column="part_name"/>
        <result property="partstock" column="part_stock"/>
        <result property="partPrice" column="part_price"/>
    </resultMap>
    <resultMap id="repairpart" type="com.ohgiraffers.hitechautoworks.repair.dto.RepairPartDTO">

        <association property="resDTO" resultMap="res" />
        <association property="partDTO" resultMap="part" />
    </resultMap>

    <resultMap id="repair" type="com.ohgiraffers.hitechautoworks.repair.dto.RepairDTO">
        <result property="content" column="repair_content"/>
        <result property="date" column="repair_date"/>
        <result property="status" column="repair_status"/>
        <association property="resDTO" resultMap="res" />
    </resultMap>

    <resultMap id="repair2" type="com.ohgiraffers.hitechautoworks.repair.dto.Repair2DTO">
        <association property="repairDTO" resultMap="repair" />
        <association property="userDTO" resultMap="user" />
        <association property="workerDTO" resultMap="worker" />
        <association property="partDTO" resultMap="part" />
        <association property="repairPartDTO" resultMap="repairpart" />
        <association property="resDTO" resultMap="res" />
    </resultMap>

    <select id="findAllRepair" resultType="map">
        SELECT
        a.res_code,
        GROUP_CONCAT(DISTINCT a.repair_content ORDER BY a.repair_content SEPARATOR ', ') AS repair_content,
        a.repair_date,
        a.repair_status,
        GROUP_CONCAT(DISTINCT d.user_name ORDER BY d.user_name SEPARATOR ', ') AS repair_workers,
        GROUP_CONCAT(DISTINCT f.part_name ORDER BY f.part_name SEPARATOR ', ') AS part_names,
        u.user_name
        FROM
        tbl_repair a
        JOIN tbl_res b ON a.res_code = b.res_code
        JOIN tbl_user u ON b.user_code = u.user_code
        JOIN tbl_repair_workers c ON a.res_code = c.res_code
        JOIN tbl_user d ON c.user_code = d.user_code
        JOIN tbl_repair_part e ON a.res_code = e.res_code
        JOIN tbl_part f ON e.part_code = f.part_code
        GROUP BY
        a.res_code, a.repair_date, a.repair_status, u.user_name
        ORDER BY a.repair_date DESC;
    </select>

    <select id="SearchByworkerCode" resultType="map">
        SELECT
        a.res_code,
        GROUP_CONCAT(DISTINCT a.repair_content ORDER BY a.repair_content SEPARATOR ', ') AS repair_content,
        a.repair_date,
        a.repair_status,
        GROUP_CONCAT(DISTINCT d.user_name ORDER BY d.user_name SEPARATOR ', ') AS repair_workers,
        GROUP_CONCAT(DISTINCT f.part_name ORDER BY f.part_name SEPARATOR ', ') AS part_names,
        u.user_name
        FROM
        tbl_repair a
        JOIN tbl_res b ON a.res_code = b.res_code
        JOIN tbl_user u ON b.user_code = u.user_code
        JOIN tbl_repair_workers c ON a.res_code = c.res_code
        JOIN tbl_user d ON c.user_code = d.user_code
        JOIN tbl_repair_part e ON a.res_code = e.res_code
        JOIN tbl_part f ON e.part_code = f.part_code
        WHERE
            d.user_code LIKE CONCAT('%', #{workerCode}, '%')
        GROUP BY
            a.res_code, a.repair_date, a.repair_status, u.user_name

    </select>
    <select id="SearchByworkerName" resultType="map">
        SELECT
        a.res_code,
        GROUP_CONCAT(DISTINCT a.repair_content ORDER BY a.repair_content SEPARATOR ', ') AS repair_content,
        a.repair_date,
        a.repair_status,
        GROUP_CONCAT(DISTINCT d.user_name ORDER BY d.user_name SEPARATOR ', ') AS repair_workers,
        GROUP_CONCAT(DISTINCT f.part_name ORDER BY f.part_name SEPARATOR ', ') AS part_names,
        u.user_name
        FROM
        tbl_repair a
        JOIN tbl_res b ON a.res_code = b.res_code
        JOIN tbl_user u ON b.user_code = u.user_code
        JOIN tbl_repair_workers c ON a.res_code = c.res_code
        JOIN tbl_user d ON c.user_code = d.user_code
        JOIN tbl_repair_part e ON a.res_code = e.res_code
        JOIN tbl_part f ON e.part_code = f.part_code
        WHERE
        d.user_name LIKE CONCAT('%', #{worker}, '%')
        GROUP BY
        a.res_code, a.repair_date, a.repair_status, u.user_name

    </select>
    <select id="selectRepair" resultMap="repair">
        SELECT
            res_code,
            repair_content,
            repair_status,
            repair_date,
            repair_time
        FROM
            tbl_repair
        WHERE
            res_code = #{resCode};
    </select>

    <update id="modifyRepair">
        UPDATE tbl_repair
        <set>
            <if test="content != null">repair_content = #{content},</if>
            <if test="status != null">repair_status = #{status},</if>
            <if test="date != null">repair_date = #{date},</if>

        </set>
        WHERE res_code = #{resCode}
    </update>
    <select id="selectUserCodeByUserName" resultType="int">
        SELECT DISTINCT user_code FROM tbl_user WHERE user_name IN
        <foreach item="userName" collection="list" open="(" separator="," close=")">
            <if test="userName != null"> #{userName} </if>
        </foreach>
    </select>
    <select id="selectPartCodeByPartName" resultType="int">
        SELECT DISTINCT part_code  FROM tbl_part WHERE part_name IN
        <foreach item="partName" collection="list" open="(" separator="," close=")">
           <if test="partName != null">  #{partName} </if>
        </foreach>
    </select>
    <insert id="modifyRepairWorker" >
<!--        <selectKey keyProperty="isDuplicate" resultType="java.lang.Integer" order="BEFORE">-->
<!--            SELECT COUNT(*) FROM tbl_repair_workers-->
<!--            WHERE user_code = #{newUserCode} AND res_code = #{resCode}-->
<!--        </selectKey>-->
<!--        <if test="isDuplicate == 0">-->
            INSERT INTO tbl_repair_workers (user_code, res_code)
            VALUES
            <foreach item="newUserCode" collection="newUserCode" separator=",">
                (
                #{newUserCode},
                #{resCode}
                )
            </foreach>
<!--        </if>-->
    </insert>
    <insert id="modifyRepairPart">
<!--        <selectKey keyProperty="isDuplicate" resultType="java.lang.Integer" order="BEFORE">-->
<!--            SELECT COUNT(*) FROM tbl_repair_part-->
<!--            WHERE part_code = #{newPartCode} AND res_code = #{resCode}-->
<!--        </selectKey>-->
<!--        <if test="isDuplicate == 0">-->
            INSERT INTO tbl_repair_part (part_code, res_code)
            VALUES
            <foreach item="newPartCode" collection="newPartCode" separator=",">
                (
                #{newPartCode},
                #{resCode}
                )
            </foreach>
<!--        </if>-->
    </insert>
    <delete id="deleteRepair">
        DELETE FROM
        tbl_repair
        WHERE
        res_code = #{ resCode }
    </delete>
    <select id="findPartList" resultMap="part">
        SELECT
            *
        FROM
            tbl_part
    </select>
    <select id="findWorkerList" >
        SELECT DISTINCT
            a.user_name
        FROM tbl_user a
        WHERE a.user_role = 'EMPLOYEE'
        AND a.user_name NOT IN (SELECT DISTINCT
                                     a.user_name
                                FROM
                                    tbl_user a
                                JOIN tbl_repair_workers b ON a.user_code = b.user_code
                                JOIN tbl_repair c ON b.res_code = c.res_code
                                WHERE  a.user_role = 'EMPLOYEE' AND (SELECT
                                                                        res_date
                                                                    FROM tbl_res
                                                                    WHERE res_code = #{code}) = c.repair_date);
    </select>
    <select id="findResList" resultMap="res">
        SELECT
            a.res_code,
            a.res_title,
            a.res_option,
            a.res_date,
            a.res_extra,
            b.user_role
        FROM
            tbl_res a
        JOIN
            tbl_user b ON (a.user_code = b.user_code)
        LEFT JOIN tbl_repair c ON a.res_code = c.res_code
        WHERE c.res_code IS NULL
    </select>
    <insert id="addRepair" >
        INSERT INTO tbl_repair(res_code,repair_content, repair_status, repair_date, repair_time)
        VALUES(
            #{ resCode },
            #{ content },
            #{ status },
            #{ date },
            #{ extraTime }
        )
    </insert>
    <select id="getDate">
        SELECT
            res_date
        FROM
            tbl_res
        WHERE res_code = #{code}
    </select>
    <insert id="addRepairPart">
        INSERT INTO tbl_repair_part(part_code, res_code)
        VALUES
        <foreach item="newPartCode" collection="newPartCode" separator=",">
            (
            #{newPartCode},
            #{resCode}
        )
        </foreach>
    </insert>

    <delete id="deleteOldWorker">
        DELETE FROM tbl_repair_workers
        WHERE
        res_code = #{resCode}
    </delete>

    <delete id="deleteOldPart">
        DELETE FROM tbl_repair_part
        WHERE
             res_code = #{resCode}
    </delete>
    <insert id="addRepairWorker">
        INSERT INTO tbl_repair_workers(user_code, res_code)
        VALUES
        <foreach item="newUserCode" collection="newUserCode" separator=",">
            (
            #{newUserCode},
            #{resCode}
            )
        </foreach>
    </insert>
    <select id="selectRepairPart" resultMap="repairpart">
        SELECT DISTINCT
        b.part_name
        FROM
            tbl_repair_part a
        JOIN tbl_part b ON (a.part_code=b.part_code)
        WHERE a.res_code = #{resCode}
    </select>
    <select id="selectWorker" resultMap="worker">
        SELECT DISTINCT
        b.user_name
        FROM
            tbl_repair_workers a
        JOIN tbl_user b ON (a.user_code=b.user_code)
        WHERE a.res_code = #{resCode}
    </select>

    <select id="modalClick" >
        SELECT b.PART_NAME,a.res_code,b.part_code
        FROM tbl_part b
        JOIN tbl_repair_part a
        ON a.part_code = b.part_code
        WHERE a.res_code = #{resCode}
    </select>

    <select id="selectPartStock">
        SELECT part_stock
        FROM tbl_part
        WHERE part_code = #{partCode}
    </select>
    <update id="modifyPartStock">
        UPDATE tbl_part
        SET part_stock = #{modifyStock}
        WHERE part_code = #{partCode}
    </update>
    <update id="modifyStatus">
        UPDATE tbl_repair
        SET repair_status = "완료"
        WHERE res_code = #{resCode}
    </update>

</mapper>